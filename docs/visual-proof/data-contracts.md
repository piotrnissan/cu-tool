# Data Contracts — JSON Schemas

This document defines the three JSON contracts used in the visual proof + human QA workflow.

---

## 1. Detections Export Schema (`detections.json`)

**Source**: Exported from `david_component_usage` + `url_inventory` tables  
**Purpose**: Input to proof runner (maps DB detections to live DOM)  
**Format**: JSON array of URL records

### Schema

```typescript
interface Detection {
  url: string; // Full URL (https://...)
  market: string; // "UK"
  slug: string; // Derived from URL (e.g., "juke", "electric-vehicles")
  components: ComponentInstance[];
}

interface ComponentInstance {
  component_key: string; // One of v1 model: hero, promo_section, media_text_split, info_specs, next_action_panel, image_carousel, card_carousel, cards_section, accordion, tabs, anchor_nav
  instance_count: number; // Number of instances detected on page
  evidence: Evidence; // Parsed from evidence string in DB
  media_type?: string; // For media_text_split: image | video | carousel
  card_type?: string; // For cards_section/card_carousel: model_grade | accessory | offer | generic
}

interface Evidence {
  // Common fields
  deduped?: boolean; // Whether duplicates were removed
  controls?: boolean | string; // "yes" | "no" | true | false

  // Carousel-specific
  items?: number[]; // Array of item counts per carousel instance

  // Accordion-specific
  total_accordions?: number; // Total count

  // Cards section-specific
  sections?: number; // Number of card sections

  // Tabs-specific
  tabs_count?: number; // Number of tab sets
}
```

### Example

```json
[
  {
    "url": "https://www.nissan.co.uk/vehicles/new-vehicles/juke.html",
    "market": "UK",
    "slug": "juke",
    "components": [
      {
        "component_key": "image_carousel",
        "instance_count": 5,
        "evidence": {
          "deduped": true,
          "items": [20, 6, 6, 8, 6],
          "controls": "yes"
        }
      },
      {
        "component_key": "card_carousel",
        "instance_count": 1,
        "evidence": {
          "deduped": true,
          "items": [6],
          "controls": true
        }
      }
    ]
  }
]
```

### Constraints

- Array contains exactly 5 objects (2 VLP + 3 Editorial)
- Each `component_key` must be valid taxonomy key
- `instance_count` must match length of `evidence.items` array (if present)
- File size < 50KB

---

## 2. Manifest Schema (`<slug>.manifest.json`)

**Source**: Generated by proof runner after live DOM query  
**Purpose**: Documents which elements were actually found and highlighted  
**Format**: JSON object per URL

### Manifest Schema Definition

```typescript
interface Manifest {
  url: string; // Full URL
  slug: string; // Same as detections.json
  timestamp: string; // ISO 8601 (when screenshot captured)
  viewport: Viewport; // Browser viewport config
  highlights: Highlight[]; // Array of detected components (may differ from detections.json)
}

interface Viewport {
  width: number; // 1920
  height: number; // 1080
}

interface Highlight {
  component_key: string; // Component type
  selector_summary: string; // CSS selector or tag (e.g., "section.wds-carousel-section")
  bbox: BoundingBox; // Document coordinates
  note?: string; // Optional debug info (e.g., "Detected carousel with 20 images")
}

interface BoundingBox {
  x: number; // Document x (scrollX + rect.x)
  y: number; // Document y (scrollY + rect.y)
  width: number; // Element width
  height: number; // Element height
}
```

### Manifest Example

```json
{
  "url": "https://www.nissan.co.uk/vehicles/new-vehicles/juke.html",
  "slug": "juke",
  "timestamp": "2026-01-20T14:32:10.123Z",
  "viewport": {
    "width": 1920,
    "height": 1080
  },
  "highlights": [
    {
      "component_key": "image_carousel",
      "selector_summary": "section.wds-carousel-section",
      "bbox": {
        "x": 0,
        "y": 6229.65625,
        "width": 1920,
        "height": 811.40625
      },
      "note": "Detected carousel with 20 images"
    },
    {
      "component_key": "image_carousel",
      "selector_summary": "div.image-gallery",
      "bbox": {
        "x": 0,
        "y": 8450.125,
        "width": 1920,
        "height": 450.5
      },
      "note": "Detected carousel with 6 images"
    }
  ]
}
```

### Manifest Constraints

- `highlights` array may differ from `detections.json` (runner uses locator strategy, may find more/fewer)
- `bbox.y` must be positive (document coordinates, not viewport-relative)
- `bbox.height` ≥ 20, `bbox.width` ≥ 50 (visibility validation)
- `timestamp` is point-in-time (page structure may change)

---

## 3. Labels Schema (`labels.jsonl`)

**Source**: Generated by QA UI (human operator)  
**Purpose**: Ground truth for regression gates  
**Format**: JSONL (newline-delimited JSON, append-only)

### Labels Schema Definition

```typescript
interface Label {
  url: string; // Full URL
  component_key: string; // Component type being labeled (as detected)
  bbox: BoundingBox; // Same as manifest (for correlation)
  label: "confirm" | "wrong" | "skip"; // Human judgment
  corrected_component_key?: string; // Present when label="wrong", operator's correction from dropdown (11 v1 types + "None / False positive" + "Other")
  media_type?: string; // For media_text_split: image | video | carousel (when correcting to media_text_split)
  card_type?: string; // For cards_section/card_carousel: model_grade | accessory | offer | generic (when correcting to cards_section or card_carousel)
  note?: string; // Optional text (max 100 chars, present when corrected_component_key="Other")
  timestamp: string; // ISO 8601 (when labeled)
}

interface BoundingBox {
  x: number;
  y: number;
  width: number;
  height: number;
}
```

### Labels Example

```jsonl
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"image_carousel","bbox":{"x":0,"y":6229.65625,"width":1920,"height":811.40625},"label":"confirm","timestamp":"2026-01-20T15:10:42.456Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"image_carousel","bbox":{"x":0,"y":8450.125,"width":1920,"height":450.5},"label":"confirm","timestamp":"2026-01-20T15:10:45.789Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"card_carousel","bbox":{"x":0,"y":12100.5,"width":1920,"height":520.25},"label":"wrong","corrected_component_key":"image_carousel","timestamp":"2026-01-20T15:11:02.123Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"accordion","bbox":{"x":0,"y":15200.75,"width":1920,"height":320.5},"label":"wrong","corrected_component_key":"None / False positive","timestamp":"2026-01-20T15:11:18.456Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"hero","bbox":{"x":0,"y":50.25,"width":1920,"height":720.5},"label":"wrong","corrected_component_key":"promo_section","timestamp":"2026-01-20T15:11:30.123Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"image_carousel","bbox":{"x":200,"y":2400.5,"width":1520,"height":480.25},"label":"wrong","corrected_component_key":"media_text_split","media_type":"carousel","timestamp":"2026-01-20T15:11:45.789Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"cards_section","bbox":{"x":0,"y":5200.75,"width":1920,"height":620.5},"label":"confirm","card_type":"model_grade","timestamp":"2026-01-20T15:12:02.456Z"}
{"url":"https://www.nissan.co.uk/vehicles/new-vehicles/juke.html","component_key":"tabs","bbox":{"x":50,"y":3400.25,"width":1820,"height":180.5},"label":"wrong","corrected_component_key":"Other","note":"Looks like segmented control not tabs","timestamp":"2026-01-20T15:12:18.789Z"}
```

### Labels Constraints

- **JSONL format**: One JSON object per line, NO array wrapper, NO commas between objects
- Each line must be valid JSON (parseable in isolation)
- Append-only (no edits, no deletes)
- `label` must be one of: `"confirm"`, `"wrong"`, `"skip"`
- `corrected_component_key` is **required when `label="wrong"`**, selected from fixed list: hero, promo_section, media_text_split, info_specs, next_action_panel, image_carousel, card_carousel, cards_section, accordion, tabs, anchor_nav, "None / False positive", "Other"
- `media_type` is **optional**, only present when `corrected_component_key="media_text_split"` (image|video|carousel)
- `card_type` is **optional**, only present when `corrected_component_key="cards_section"` or `corrected_component_key="card_carousel"` (model_grade|accessory|offer|generic)
- `note` is **optional**, only present when `corrected_component_key="Other"` (max 100 chars)
- `bbox` must match a highlight from corresponding manifest JSON (for correlation)

### Why JSONL?

1. **Append-only**: New labels added without re-parsing entire file
2. **Streaming-friendly**: Can process labels line-by-line (memory-efficient)
3. **Corruption-resistant**: If write fails mid-line, previous lines remain valid
4. **No save button needed**: Atomic append after each label action

**NOT JSON array**:

- ❌ Requires parsing entire file to append new element
- ❌ Corrupted if write interrupted (missing closing bracket)
- ❌ Requires "save" button (batch writes)

---

## Correlation Between Schemas

```text
detections.json (DB export)
    ↓
    [ Runner queries live DOM using locator strategy ]
    ↓
<slug>.manifest.json (actual found elements)
    ↓
    [ Human operator labels each highlight ]
    ↓
labels.jsonl (ground truth for regression gates)
```

**Key insight**: `detections.json` shows what the detector CLAIMS to have found (from HTML cache). `manifest.json` shows what the runner ACTUALLY found (from live DOM). `labels.jsonl` shows what a HUMAN judged as correct/wrong.

**Discrepancies are expected**:

- DOM may have changed since HTML was cached
- Locator strategy may be more/less strict than detector
- Human may disagree with detector logic (e.g., "this is a card carousel, NOT an image carousel")

Discrepancies are the POINT of this exercise — they reveal detector issues that need fixing in Phase 4.

---

## Related Documentation

- [Overview](overview.md) — What the proof pack is
- [Runner Documentation](runner.md) — Locator strategy details
- [QA UI Documentation](qa-ui.md) — How labels are created
- [Quality Gates](quality-gates.md) — How labels are used for validation
